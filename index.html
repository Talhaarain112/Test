<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
<title>TMveb</title>
<style>
/* === NEW THEME (No Changes) === */
:root {
    --primary-color: #0d9488; --primary-hover-color: #0f766e; --secondary-color: #f59e0b; --secondary-hover-color: #d97706; --accent-color: #0d9488;
    --background-color: #f0f2f5; --card-bg: #ffffff; --text-color-dark: #111827; --text-color-medium: #374151; --text-color-light: #6b7280;
    --border-color: #e5e7eb; --danger-color: #ef4444; --success-color: #10b981; --font-family: 'Inter', sans-serif;
    --box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.07), 0 1px 2px -1px rgba(0, 0, 0, 0.05); --box-shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.08), 0 4px 6px -4px rgba(0, 0, 0, 0.07);
    --border-radius: 0.75rem; --header-height: 65px;
}
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
*, *::before, *::after { box-sizing: border-box; }
body { font-family: var(--font-family); margin: 0; background-color: var(--background-color); color: var(--text-color-medium); line-height: 1.5; font-size: 15px; font-weight: 400; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; transition: padding-left 0.3s ease; }

/* *** MODIFIED: Hide auth view by default to prevent flicker on refresh *** */
#auth-view { display: none; justify-content: center; align-items: center; min-height: 100vh; padding: 20px; background-color: #e0f2f1; }

.auth-container { max-width: 400px; width: 100%; }
.auth-card { background-color: var(--card-bg); padding: 30px 35px; border-radius: var(--border-radius); box-shadow: var(--box-shadow-lg); border: 1px solid var(--border-color); }
.auth-header { text-align: center; margin-bottom: 25px; }
.auth-header .logo { font-size: 1.6rem; font-weight: 600; color: var(--primary-color); margin-bottom: 8px; }
.auth-header p { font-size: 0.9em; color: var(--text-color-light); margin: 0; font-weight: 300; }
.auth-card h2 { font-size: 1.25rem; font-weight: 500; color: var(--text-color-dark); margin: 0 0 20px 0; text-align: left; }
.form-group { margin-bottom: 15px; }
label { display: block; margin-bottom: 5px; font-weight: 500; font-size: 0.8em; color: var(--text-color-medium); }
input[type="text"], input[type="email"], input[type="password"], input[type="number"], select { display: block; width: 100%; padding: 10px 12px; border: 1px solid var(--border-color); border-radius: var(--border-radius); font-size: 0.9em; font-weight: 400; transition: border-color 0.2s ease, box-shadow 0.2s ease; background-color: #f8fafc; }
input:focus, select:focus { border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(13, 148, 136, 0.15); outline: none; }
input.error { border-color: var(--danger-color); box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.15); }
.error-message { color: var(--danger-color); font-size: 0.75em; margin-top: 4px; display: none; }
.forgot-password-link { display: block; text-align: right; font-size: 0.75em; color: var(--primary-color); text-decoration: none; margin-top: -8px; margin-bottom: 15px; font-weight: 400; } .forgot-password-link:hover { text-decoration: underline; }
.btn-submit { display: block; width: 100%; padding: 12px; font-size: 0.95em; font-weight: 600; color: white; background: linear-gradient(45deg, var(--primary-hover-color), var(--primary-color)); border: none; border-radius: var(--border-radius); cursor: pointer; transition: all 0.2s ease; margin-top: 20px; box-shadow: 0 4px 10px -2px rgba(13, 148, 136, 0.4); } 
.btn-submit:hover { transform: translateY(-2px); box-shadow: 0 6px 12px -2px rgba(13, 148, 136, 0.5); }
.btn-submit:disabled { background: #9ca3af; cursor: not-allowed; transform: none; box-shadow: none; }
.auth-switch { margin-top: 20px; text-align: center; font-size: 0.85em; color: var(--text-color-light); }
.auth-switch a { color: var(--primary-color); text-decoration: none; font-weight: 500; } .auth-switch a:hover { text-decoration: underline; }
#login-card, #signup-card, #forgot-card { display: none; }
#app-view { display: none; padding-top: var(--header-height); }
#sidenav { height: 100%; width: 250px; position: fixed; z-index: 200; top: 0; left: 0; background-color: var(--card-bg); border-right: 1px solid var(--border-color); overflow-x: hidden; transform: translateX(-100%); transition: transform 0.3s ease-in-out; padding-top: 20px; }
#sidenav.open { transform: translateX(0); }
.sidenav-header { padding: 10px 20px; font-size: 1.25rem; font-weight: 600; color: var(--primary-color); margin-bottom: 20px; }
#sidenav a { padding: 12px 20px; text-decoration: none; font-size: 0.95rem; color: var(--text-color-medium); display: flex; align-items: center; gap: 15px; transition: background-color 0.2s, color 0.2s; border-left: 3px solid transparent; }
#sidenav a:hover, #sidenav a.active { background-color: #e0f2f1; color: var(--primary-color); font-weight: 600; border-left-color: var(--primary-color); }
#sidenav a svg { width: 20px; height: 20px; fill: currentColor; }
#sidenav-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(17, 24, 39, 0.4); z-index: 150; }
#app-header { background-color: var(--card-bg); height: var(--header-height); border-bottom: 1px solid var(--border-color); box-shadow: var(--box-shadow); padding: 0 20px; display: flex; align-items: center; justify-content: space-between; position: fixed; top: 0; left: 0; width: 100%; z-index: 100; }
.header-left { display: flex; align-items: center; gap: 15px; }
#menu-toggle-btn { background: none; border: none; cursor: pointer; padding: 5px; color: var(--text-color-dark); }
#menu-toggle-btn svg { width: 24px; height: 24px; }
.header-brand { font-size: 1.15em; font-weight: 600; color: var(--primary-color); text-decoration: none; }
.header-right { display: flex; align-items: center; gap: 15px; }
.header-icon-btn { position: relative; background: none; border: none; cursor: pointer; padding: 5px; color: var(--text-color-dark); }
.header-icon-btn svg { width: 22px; height: 22px; }
.notification-badge { position: absolute; top: 0px; right: 0px; width: 10px; height: 10px; background-color: var(--danger-color); border-radius: 50%; border: 2px solid var(--card-bg); }
.content-page { display: none; }
.content-page.active { display: block; }
#app-content { padding: 20px; max-width: 700px; margin: 15px auto; }
.placeholder-content { background-color: var(--card-bg); border-radius: var(--border-radius); padding: 40px; text-align: center; border: 1px solid var(--border-color); }
.placeholder-content h1 { color: var(--text-color-dark); font-weight: 500; }
.placeholder-content p { color: var(--text-color-medium); }
.full-stat-card { background-color: var(--card-bg); padding: 24px; border-radius: var(--border-radius); border: 1px solid var(--border-color); box-shadow: var(--box-shadow); margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; }
.full-stat-info { display: flex; align-items: center; gap: 15px; }
.full-stat-emoji { font-size: 1.8rem; line-height: 1; background-color: #e0f2f1; padding: 8px; border-radius: 10px; }
.full-stat-label { font-size: 1rem; color: var(--text-color-medium); font-weight: 500; }
.full-stat-value { font-size: 1.5rem; font-weight: 700; color: var(--primary-color); }
.action-list { background-color: var(--card-bg); border-radius: var(--border-radius); box-shadow: var(--box-shadow); overflow: hidden; border: 1px solid var(--border-color); }
.action-list-item { display: flex; align-items: center; padding: 14px 18px; border-bottom: 1px solid var(--border-color); cursor: pointer; transition: background-color 0.15s ease, transform 0.15s ease; text-decoration: none; color: inherit; }
.action-list-item:last-child { border-bottom: none; }
.action-list-item:hover { background-color: #F8F9FA; transform: translateX(5px); }
.action-list-icon { flex-shrink: 0; width: 42px; height: 42px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
.action-list-icon svg { width: 20px; height: 20px; fill: white; }
.action-list-item.deposit .action-list-icon { background: linear-gradient(45deg, #10b981, #34d399); }
.action-list-item.withdraw .action-list-icon { background: linear-gradient(45deg, #ef4444, #f87171); }
.action-list-item.profile .action-list-icon { background: linear-gradient(45deg, var(--primary-hover-color), var(--primary-color)); }
.action-list-info h2 { font-size: 0.95rem; margin: 0 0 3px 0; font-weight: 500; color: var(--text-color-dark); }
.action-list-info p { font-size: 0.8rem; color: var(--text-color-light); margin: 0; line-height: 1.4; font-weight: 400; }
.action-list-arrow { margin-left: auto; color: var(--text-color-light); font-size: 1.2em; transition: transform 0.2s ease; }
.action-list-item:hover .action-list-arrow { transform: translateX(3px); }
.modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(17, 24, 39, 0.7); z-index: 1000; justify-content: center; align-items: center; padding: 15px; animation: fadeIn 0.2s ease-out; }
.modal-content { background-color: var(--card-bg); padding: 25px; border-radius: var(--border-radius); box-shadow: var(--box-shadow-lg); max-width: 480px; width: 100%; position: relative; animation: slideIn 0.25s ease-out; }
.modal-close { position: absolute; top: 8px; right: 8px; font-size: 1.5em; line-height: 1; border: none; background: none; color: var(--text-color-light); cursor: pointer; padding: 5px; } .modal-close:hover { color: var(--text-color-dark); }
.modal-content h3 { margin-top: 0; margin-bottom: 15px; font-weight: 500; font-size: 1.1rem; color: var(--primary-color); border-bottom: 1px solid var(--border-color); padding-bottom: 8px; }
.modal-content p, .modal-content .notice { font-size: 0.85em; color: var(--text-color-light); margin-bottom: 15px; font-weight: 400; line-height: 1.5; }
.modal-content .notice { background-color: #fffbeb; color: #b45309; padding: 10px; border-radius: 6px; border: 1px solid #fde68a; }
.modal-content .form-group label { font-size: 0.8em; font-weight: 500; color: var(--text-color-medium); display: block; margin-bottom: 5px; }
.modal-content input[type="text"], .modal-content input[type="number"], .modal-content select { padding: 9px 12px; font-size: 0.9em; border: 1px solid var(--border-color); border-radius: var(--border-radius); width: 100%; margin-bottom: 15px; font-weight: 400; }
.modal-content input:focus, .modal-content select:focus { border-color: var(--primary-color); box-shadow: 0 0 0 2px rgba(13, 148, 136, 0.15); outline: none; }
.modal-content .btn-group { display: flex; gap: 10px; margin-top: 15px; }
.modal-content .btn { padding: 9px 16px; font-size: 0.9em; font-weight: 500; border-radius: 0.6rem; border: none; cursor: pointer; transition: all 0.2s ease; }
.modal-content .btn-primary { background-color: var(--primary-color); color: white; } .modal-content .btn-primary:hover { background-color: var(--primary-hover-color); transform: translateY(-1px); }
.modal-content .btn-secondary { background-color: #e5e7eb; color: var(--text-color-medium); } .modal-content .btn-secondary:hover { background-color: #d1d5db; }
.modal-content code { background-color: #F3F4F6; padding: 2px 5px; border-radius: 4px; font-family: monospace; font-size: 0.9em; color: var(--primary-color); display: inline-block; margin-top: 5px; word-break: break-all; }
.input-group { display: flex; }
.input-group input { border-top-right-radius: 0; border-bottom-right-radius: 0; flex-grow: 1; }
.input-group button { border-top-left-radius: 0; border-bottom-left-radius: 0; background-color: var(--primary-color); color: white; border: 1px solid var(--primary-color); padding: 0 12px; font-size: 0.8em; cursor: pointer; flex-shrink: 0; }
.input-group button:hover { background-color: var(--primary-hover-color); }
.table-responsive { overflow-x: auto; margin-top: 10px; border: 1px solid var(--border-color); border-radius: var(--border-radius); background: var(--card-bg); }
table { width: 100%; border-collapse: collapse; }
th, td { padding: 10px 12px; text-align: left; vertical-align: middle; border-bottom: 1px solid var(--border-color); font-size: 0.85em; font-weight: 400; }
th { background-color: #F9FAFB; font-weight: 500; color: var(--text-color-light); font-size: 0.75em; text-transform: uppercase; letter-spacing: 0.5px; }
tbody tr:last-child td { border-bottom: none; }
tbody tr:hover { background-color: #f8fafc; }
td.-wrap { white-space: normal; }
.profile-info dt { font-size: 0.8em; color: var(--text-color-light); margin-bottom: 2px; font-weight: 500; }
.profile-info dd { font-size: 0.95em; color: var(--text-color-dark); margin-left: 0; margin-bottom: 10px; font-weight: 400; word-break: break-all;}
#notifications-list .notification-item { padding: 12px 0; border-bottom: 1px solid var(--border-color); font-size: 0.9em; }
#notifications-list .notification-item:last-child { border-bottom: none; }
#notifications-list .notification-item p { margin: 0; color: var(--text-color-medium); line-height: 1.4; }
#notifications-list .notification-item .timestamp { font-size: 0.75em; color: var(--text-color-light); margin-top: 4px; }
#notifications-list .no-notifications { color: var(--text-color-light); font-size: 0.9em; text-align: center; padding: 20px 0; }
.ad-card { background-color: var(--card-bg); border: 1px solid var(--border-color); border-radius: var(--border-radius); padding: 20px; margin-bottom: 15px; box-shadow: var(--box-shadow); display: flex; flex-direction: column; transition: transform 0.2s ease, box-shadow 0.2s ease; }
.ad-card:hover { transform: translateY(-3px); box-shadow: var(--box-shadow-lg); }
.ad-card h3 { margin: 0 0 10px 0; font-size: 1.1rem; font-weight: 600; color: var(--text-color-dark); }
.ad-card p { margin: 0 0 15px 0; font-size: 0.9rem; color: var(--text-color-medium); flex-grow: 1; }
.ad-details { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding-top: 10px; border-top: 1px solid var(--border-color); }
.ad-detail-item { text-align: center; flex: 1; }
.ad-detail-item .label { font-size: 0.75rem; color: var(--text-color-light); text-transform: uppercase; }
.ad-detail-item .value { font-size: 1rem; font-weight: 600; color: var(--text-color-dark); }
.btn-action { display: block; width: 100%; padding: 10px; font-size: 0.9em; font-weight: 600; color: white; border: none; border-radius: 0.6rem; cursor: pointer; transition: all 0.2s ease; text-align: center; margin-top: auto; }
.btn-action:hover { transform: translateY(-2px); }
.btn-action:disabled { background-color: #9ca3af; cursor: not-allowed; transform: none; box-shadow: none; }
.ad-card .btn-action { background: linear-gradient(45deg, var(--secondary-hover-color), var(--secondary-color)); box-shadow: 0 4px 10px -2px rgba(245, 158, 11, 0.4); }
.ad-card .btn-action:hover { box-shadow: 0 6px 12px -2px rgba(245, 158, 11, 0.5); }
.plan-card { background-color: var(--card-bg); border: 1px solid var(--border-color); border-radius: var(--border-radius); padding: 20px; margin-bottom: 20px; box-shadow: var(--box-shadow); transition: transform 0.2s ease, box-shadow 0.2s ease; }
.plan-card:hover { transform: translateY(-3px); box-shadow: var(--box-shadow-lg); }
.plan-card-header { text-align: center; font-size: 1.2rem; font-weight: 600; color: var(--primary-color); margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid var(--border-color); }
.plan-card-body { font-size: 0.95rem; color: var(--text-color-dark); }
.plan-card-body p { margin: 0 0 10px 0; display: flex; justify-content: space-between; }
.plan-card-body p span:first-child { color: var(--text-color-medium); }
.plan-card-body p strong { font-weight: 600; }
.plan-card-body .total-profit { margin-top: 15px; padding-top: 10px; border-top: 1px solid var(--border-color); font-size: 1rem; font-weight: 700; }
.plan-card .btn-action { background: linear-gradient(45deg, var(--primary-hover-color), var(--primary-color)); box-shadow: 0 4px 10px -2px rgba(13, 148, 136, 0.4); margin-top: 20px; }
.plan-card .btn-action:hover { box-shadow: 0 6px 12px -2px rgba(13, 148, 136, 0.5); }
@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
@keyframes slideIn { from { transform: translateY(-15px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
@media (max-width: 768px) { #sidenav { width: 220px; } }
</style>
</head>
<body>

<div id="auth-view">
    <div class="auth-container">
        <div id="login-card" class="auth-card">
            <div class="auth-header"> <div class="logo">TMveb</div> <p>welcome back! please login.</p> </div>
            <form id="login-form" onsubmit="handleLogin(event)">
            <div class="form-group"> <label for="login-email">email</label> <input type="email" id="login-email" required> </div>
            <div class="form-group"> <label for="login-password">password</label> <input type="password" id="login-password" required> <div id="login-error" class="error-message">Invalid email or password.</div> </div>
            <a href="#" class="forgot-password-link" onclick="showAuthPage('forgot-card'); return false;">forgot password?</a>
            <button type="submit" class="btn-submit">login</button>
            </form>
            <div class="auth-switch"> new here? <a href="#" onclick="showAuthPage('signup-card'); return false;">create an account</a> </div>
        </div>
        <div id="signup-card" class="auth-card" style="display: none;">
            <div class="auth-header"> <div class="logo">TMveb</div> <p>create your new account.</p> </div>
            <form id="signup-form" onsubmit="handleSignup(event)">
            <div class="form-group"> <label for="signup-username">username</label> <input type="text" id="signup-username" required> </div>
            <div class="form-group"> <label for="signup-email">email address</label> <input type="email" id="signup-email" required> <div id="signup-email-error" class="error-message">This email is already registered.</div> </div>
            <div class="form-group"> <label for="signup-password">password (6-12 characters)</label> <input type="password" id="signup-password" required> <div id="signup-password-error" class="error-message">Password must be 6-12 characters long.</div> </div>
            <div class="form-group"> <label for="signup-referral">referral code (optional)</label> <input type="text" id="signup-referral"> </div>
            <button type="submit" class="btn-submit">sign up</button>
            </form>
            <div class="auth-switch"> already have an account? <a href="#" onclick="showAuthPage('login-card'); return false;">login instead</a> </div>
        </div>
        <div id="forgot-card" class="auth-card" style="display: none;">
            <div class="auth-header"> <div class="logo">TMveb</div> <p>reset your password.</p> </div>
            <h2>Forgot Password</h2>
            <form id="forgot-form" onsubmit="handleForgotPassword(event)">
            <div class="form-group">
            <label for="forgot-email">Enter your email address</label>
            <input type="email" id="forgot-email" required placeholder="you@example.com">
            <div id="forgot-email-error" class="error-message">Email not found or error sending.</div>
            </div>
            <p style="font-size: 0.8em; color: var(--text-color-light); text-align: left;">We'll send a password reset link to your email.</p>
            <button type="submit" class="btn-submit">Send Reset Link</button>
            </form>
            <div class="auth-switch"> Remember password? <a href="#" onclick="showAuthPage('login-card'); return false;">Back to Login</a> </div>
        </div>
    </div>
</div>

<div id="app-view">
    <div id="sidenav">
        <div class="sidenav-header">TMveb Menu</div>
        <a href="#dashboard-page" class="nav-link active" data-page="dashboard-page"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 13v8h8v-8h-8zM3 21h8v-8H3v8zM3 3v8h8V3H3zm13.66-1.31L11 7.34 16.66 13l5.66-5.66-5.66-5.65z"/></svg>Dashboard</a>
        <a href="#wallet-page" class="nav-link" data-page="wallet-page"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M21 18v1c0 1.1-.9 2-2 2H5c-1.11 0-2-.9-2-2V5c0-1.1.89-2 2-2h14c1.1 0 2 .9 2 2v1h-9c-1.11 0-2 .9-2 2v8c0 1.1.89 2 2 2h9zm-9-2h10V8H12v8zm4-2.5c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5z"/></svg>Wallet</a>
        <a href="#ads-page" class="nav-link" data-page="ads-page"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.5 4c.83 0 1.5.67 1.5 1.5v13c0 .83-.67 1.5-1.5 1.5H15v-5h2.5l.37-2.99h-2.87V9.02c0-.87.24-1.46 1.49-1.46H18.5V4.99c-.32-.04-.65-.06-1-.06-2.03 0-3.44 1.24-3.44 3.53V10H11v3h3v5H3.5c-.83 0-1.5-.67-1.5-1.5v-13C2 4.67 2.67 4 3.5 4h17z"/></svg>Ads</a>
        <a href="#plans-page" class="nav-link" data-page="plans-page"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3.5 18.49l6-6.01 4 4L22 6.92l-1.41-1.41-7.09 7.97-4-4L2 16.99z"/></svg>Plans</a>
        <a href="#my-team-page" class="nav-link" data-page="my-team-page"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z"/></svg>My Team</a>
        <a href="#" id="sidenav-logout"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M16 13v-2h-5v-2h5V7l5 5-5 5zm-8-3H3v2h5v-2zM5 3h14c1.1 0 2 .9 2 2v2h-2V5H5v14h14v-2h2v2c0 1.1-.9 2-2 2H5c-1.1 0-2-.9-2-2V5c0-1.1.9-2 2-2z"></path></svg>Logout</a>
    </div>
    <div id="sidenav-overlay"></div>
    <header id="app-header">
        <div class="header-left">
            <button id="menu-toggle-btn" title="Open Menu"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"></path></svg></button>
            <div class="header-brand">Dashboard</div>
        </div>
        <div class="header-right">
            <button class="header-icon-btn" title="Notifications" onclick="openModal('notifications-modal')">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 22c1.1 0 2-.9 2-2h-4c0 1.1.9 2 2 2zm6-6v-5c0-3.07-1.63-5.64-4.5-6.32V4c0-.83-.67-1.5-1.5-1.5s-1.5.67-1.5 1.5v.68C7.64 5.36 6 7.92 6 11v5l-2 2v1h16v-1l-2-2z"></path></svg>
                <div id="notification-badge" class="notification-badge"></div>
            </button>
            <a href="#" class="action-list-item profile" onclick="openModal('profile-modal')" style="padding:0; border:none; background:none;">
                <div class="action-list-icon" style="margin-right:0;">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="white"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"></path></svg>
                </div>
            </a>
        </div>
    </header>
    <main>
        <div id="dashboard-page" class="content-page active">
            <div id="app-content">
                <div class="full-stat-card">
                    <div class="full-stat-info"><span class="full-stat-emoji">💰</span><div class="full-stat-label">Main Balance</div></div>
                    <div class="full-stat-value" id="dashboard-main-balance">0.00 Usdt</div>
                </div>
                <div class="full-stat-card">
                    <div class="full-stat-info"><span class="full-stat-emoji">📥</span><div class="full-stat-label">Deposit Balance</div></div>
                    <div class="full-stat-value" id="dashboard-deposit-balance">0.00 Usdt</div>
                </div>
                <div class="full-stat-card">
                    <div class="full-stat-info"><span class="full-stat-emoji">☀️</span><div class="full-stat-label">Today Earning</div></div>
                    <div class="full-stat-value" id="dashboard-today-earning">0.00 Usdt</div>
                </div>
                <div class="full-stat-card">
                    <div class="full-stat-info"><span class="full-stat-emoji">🗓️</span><div class="full-stat-label">Last Week Earning</div></div>
                    <div class="full-stat-value" id="dashboard-last-week-earning">0.00 Usdt</div>
                </div>
                <div class="full-stat-card">
                    <div class="full-stat-info"><span class="full-stat-emoji">🏆</span><div class="full-stat-label">Total Earning</div></div>
                    <div class="full-stat-value" id="dashboard-total-earning">0.00 Usdt</div>
                </div>
            </div>
        </div>
        <div id="wallet-page" class="content-page">
            <div id="app-content">
                <div class="action-list">
                    <a href="#" class="action-list-item deposit" onclick="openModal('deposit-modal')">
                        <div class="action-list-icon"> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M19 12v7H5v-7H3v7c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2v-7h-2zm-6 .67l2.59-2.58L17 11.5l-5 5-5-5 1.41-1.41L11 12.67V3h2v9.67z"></path></svg> </div>
                        <div class="action-list-info"> <h2>deposit</h2> <p>add funds via available networks.</p> </div>
                        <div class="action-list-arrow">›</div>
                    </a>
                    <a href="#" class="action-list-item withdraw" onclick="openModal('withdraw-modal')">
                        <div class="action-list-icon"> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M5 12v-7h14v7h2V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v7h2zm7 3.67L19.59 11.09 21 12.5l-9 9-9-9 1.41-1.41L11 15.67V7h2v8.67z"></path></svg> </div>
                        <div class="action-list-info"> <h2>withdraw</h2> <p>receive within 3 days.</p> </div>
                        <div class="action-list-arrow">›</div>
                    </a>
                </div>
            </div>
        </div>
        <div id="ads-page" class="content-page">
            <div id="app-content">
                <div id="ads-container"></div>
            </div>
        </div>
        <div id="plans-page" class="content-page">
            <div id="app-content">
                <div id="plans-container"></div>
            </div>
        </div>
        <div id="my-team-page" class="content-page">
            <div id="app-content">
                <div class="form-group">
                    <label>Your Referral Link</label>
                    <div class="input-group">
                        <input type="text" id="page-referral-link" value="Loading..." readonly style="background:#f3f4f6;">
                        <button onclick="copyToClipboard(document.getElementById('page-referral-link').value)">Copy</button>
                    </div>
                </div>
                <h3 style="font-weight: 500; font-size: 1.1rem; margin-top: 30px; margin-bottom: 15px; border-bottom: 1px solid var(--border-color); padding-bottom: 8px;">Referred Members</h3>
                <div class="table-responsive">
                    <table>
                        <thead> <tr> <th>Username</th> <th class="wrap">Email</th> <th>Total Deposit (USDT)</th> </tr> </thead>
                        <tbody id="team-members-list"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>
    <div id="deposit-modal" class="modal-overlay" onclick="closeModal(this, event)">
        <div class="modal-content">
            <button class="modal-close" onclick="closeModalButton('deposit-modal')">×</button>
            <h3>deposit usdt</h3>
            <p>minimum deposit: <strong id="deposit-min-text">10</strong><strong> Usdt</strong></p>
            <div id="deposit-wallets-container" style="margin-bottom: 20px;">
                <p>Loading available addresses...</p>
            </div>
            <form id="deposit-form" onsubmit="handleDepositSubmit(event)">
                <div class="form-group"> <label for="deposit-method-select">payment sent from</label> <select id="deposit-method-select" required> <option value="">-- select network --</option> <option value="TRC20">TRC20</option> <option value="BEP20">BEP20</option> </select> </div>
                <div class="form-group"> <label for="deposit-account-number">your wallet address (sender)</label> <input type="text" id="deposit-account-number" placeholder="" required> </div>
                <div class="form-group"> <label for="deposit-amount-input">amount sent (usdt)</label> <input type="number" id="deposit-amount-input" step="1" min="10" required> </div>
                <div class="form-group"> <label for="deposit-txid-input">transaction id (tid)</label> <input type="text" id="deposit-txid-input" required> </div>
                <div class="btn-group"> <button type="button" class="btn btn-secondary" onclick="closeModalButton('deposit-modal')">cancel</button> <button type="submit" class="btn btn-primary">submit proof</button> </div>
            </form>
        </div>
    </div>
    <div id="withdraw-modal" class="modal-overlay" onclick="closeModal(this, event)">
        <div class="modal-content">
            <button class="modal-close" onclick="closeModalButton('withdraw-modal')">×</button>
            <h3>request withdrawal</h3>
            <p>min: <strong id="withdraw-min-text">10</strong><strong> usdt</strong> | processing: <strong>~3 days</strong>.</p>
            <form id="withdraw-form" onsubmit="handleWithdrawSubmit(event)">
                <div class="form-group"> <label for="withdraw-amount-input">amount (usdt)</label> <input type="number" id="withdraw-amount-input" step="1" min="10" required> </div>
                <div class="form-group"> <label for="withdraw-method">method</label> <select id="withdraw-method" required> <option value="">-- select --</option> <option value="TRC20">TRC20</option> <option value="BEP20">BEP20</option> </select> </div>
                <div id="withdraw-account-fields"> <div class="form-group"> <label for="withdraw-account-number">your wallet address </label> <input type="text" id="withdraw-account-number" placeholder="You Wallet address " required> </div> </div>
                <div class="btn-group"> <button type="button" class="btn btn-secondary" onclick="showWithdrawHistory()">view history</button> <button type="submit" class="btn btn-primary">request</button> </div>
            </form>
            <div id="withdraw-history-section" style="display: none; margin-top: 20px;">
                <div class="table-responsive"><table><thead> <tr> <th>date</th> <th>amount (usdt)</th> <th>account</th> <th>status</th> </tr> </thead></table></div>
            </div>
        </div>
    </div>
    <div id="profile-modal" class="modal-overlay" onclick="closeModal(this, event)">
        <div class="modal-content">
            <button class="modal-close" onclick="closeModalButton('profile-modal')">×</button>
            <h3>my profile</h3>
            <dl class="profile-info"> <dt>user id</dt> <dd id="profile-id">USR-123456789</dd> <dt>username</dt> <dd id="profile-username">[Username]</dd> <dt>email</dt> <dd id="profile-email">user@example.com</dd> </dl>
            <div class="btn-group" style="justify-content: flex-end; margin-top: 20px;">
                <button type="button" class="btn btn-secondary" onclick="openUpdateProfileModal()">Update Password</button>
                <button type="button" class="btn btn-primary" onclick="closeModalButton('profile-modal')">Close</button>
            </div>
        </div>
    </div>
    <div id="notifications-modal" class="modal-overlay" onclick="closeModal(this, event)">
        <div class="modal-content">
            <button class="modal-close" onclick="closeModalButton('notifications-modal')">×</button>
            <h3>Notifications</h3>
            <div id="notifications-list">
                <div class="no-notifications">You have no new notifications.</div>
            </div>
            <div style="text-align: right; margin-top: 20px;">
                <button type="button" class="btn btn-secondary" onclick="closeModalButton('notifications-modal')">Close</button>
            </div>
        </div>
    </div>
    <div id="update-profile-modal" class="modal-overlay" onclick="closeModal(this, event)">
        <div class="modal-content">
            <button class="modal-close" onclick="closeModalButton('update-profile-modal')">×</button>
            <h3>Update Password</h3>
            <p>For security, please provide your current password to set a new one.</p>
            <form id="update-password-form" onsubmit="handlePasswordUpdate(event)">
                <div class="form-group">
                    <label for="current-password">Current Password</label>
                    <input type="password" id="current-password" required>
                    <div id="current-password-error" class="error-message"></div>
                </div>
                <div class="form-group">
                    <label for="new-password">New Password (6-12 characters)</label>
                    <input type="password" id="new-password" required>
                    <div id="new-password-error" class="error-message">Password must be 6-12 characters long.</div>
                </div>
                <div class="form-group">
                    <label for="confirm-new-password">Confirm New Password</label>
                    <input type="password" id="confirm-new-password" required>
                    <div id="confirm-password-error" class="error-message">Passwords do not match.</div>
                </div>
                <div class="btn-group" style="justify-content: flex-end;">
                    <button type="button" class="btn btn-secondary" onclick="closeModalButton('update-profile-modal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Update Password</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

<script>
const firebaseConfig = {
    apiKey: "AIzaSyD6Vq7sFI4gYAUjMXbE747T7bDUZE1a7V8",
    authDomain: "tmveb-f6461.firebaseapp.com",
    databaseURL: "https://tmveb-f6461-default-rtdb.firebaseio.com",
    projectId: "tmveb-f6461",
    storageBucket: "tmveb-f6461.firebasestorage.app",
    messagingSenderId: "658471205950",
    appId: "1:658471205950:web:c74823c649c6ce8029256f",
    measurementId: "G-9DVC401E1M"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

const authView = document.getElementById('auth-view');
const appView = document.getElementById('app-view');
const authCards = {
    'login-card': document.getElementById('login-card'),
    'signup-card': document.getElementById('signup-card'),
    'forgot-card': document.getElementById('forgot-card'),
};
const menuToggleBtn = document.getElementById('menu-toggle-btn');
const sidenav = document.getElementById('sidenav');
const sidenavOverlay = document.getElementById('sidenav-overlay');
const navLinks = document.querySelectorAll('.nav-link');
const contentPages = document.querySelectorAll('.content-page');
const sidenavLogoutBtn = document.getElementById('sidenav-logout');
let unsubscribeNotifications = null;
let transactionSettings = { minDeposit: 10, minWithdrawal: 10 };
let currentUserData = null; 

document.addEventListener('DOMContentLoaded', () => {
    const params = new URLSearchParams(window.location.search);
    const refCode = params.get('ref');
    if (refCode) {
        showAuthPage('signup-card');
        const referralInput = document.getElementById('signup-referral');
        if (referralInput) { referralInput.value = refCode; }
    }
    document.querySelectorAll(".modal-overlay").forEach(e => e.style.display = "none");
    
    // This part stays: It sets the correct page active in the background
    const initialPageId = window.location.hash.substring(1) || 'dashboard-page';
    handlePageNavigation(initialPageId, false); // false to prevent adding to history again
});

window.onpopstate = function(event) {
    const pageId = (event.state && event.state.pageId) || 'dashboard-page';
    handlePageNavigation(pageId, false);
};

// *** MODIFIED: Logic now correctly shows/hides views to prevent flicker ***
auth.onAuthStateChanged(user => {
    if (user) {
        // User is logged in
        db.collection('users').doc(user.uid).onSnapshot(doc => {
            if (doc.exists) {
                currentUserData = { id: doc.id, ...doc.data() };
                if (currentUserData.isBlocked === true) {
                    handleLogout();
                    setTimeout(() => alert('Your account has been blocked by an administrator.'), 200);
                    return;
                }
                if (unsubscribeNotifications) unsubscribeNotifications();
                displayUserInfo(currentUserData);
                fetchAndDisplayNotifications(user.uid);
                listenForTransactionSettings();
                
                const activePage = document.querySelector('.content-page.active')?.id || 'dashboard-page';
                refreshPageContent(activePage);

                // Show app, hide auth
                authView.style.display = 'none';
                appView.style.display = 'block';
            } else { 
                handleLogout(); 
            }
        }, error => { 
            console.error("Error fetching user data:", error); 
            handleLogout(); 
        });
    } else {
        // User is logged out
        currentUserData = null;
        if (unsubscribeNotifications) unsubscribeNotifications();
        
        // Show auth, hide app
        authView.style.display = 'flex';
        appView.style.display = 'none';

        // Check for referral code and show signup if present, otherwise login
        const params = new URLSearchParams(window.location.search);
        if (params.has('ref')) {
            showAuthPage('signup-card');
        } else {
            showAuthPage('login-card');
        }
    }
});

async function handleLogin(e) { e.preventDefault(); clearErrors(); const email = document.getElementById("login-email").value; const password = document.getElementById("login-password").value; const loginError = document.getElementById("login-error"); try { const userCredential = await auth.signInWithEmailAndPassword(email, password); const user = userCredential.user; const userDoc = await db.collection('users').doc(user.uid).get(); if (userDoc.exists && userDoc.data().isBlocked === true) { await auth.signOut(); loginError.textContent = 'This account is blocked. Please contact support.'; loginError.style.display = 'block'; } else { window.location.hash = 'dashboard-page'; } } catch (error) { console.error("Login Error:", error.code, error.message); loginError.textContent = 'Invalid email or password.'; loginError.style.display = 'block'; document.getElementById("login-email").classList.add("error"); document.getElementById("login-password").classList.add("error"); } }
async function handleSignup(e) { e.preventDefault(); clearErrors(); const t = document.getElementById("signup-username").value, n = document.getElementById("signup-email").value, o = document.getElementById("signup-password").value, a = document.getElementById("signup-referral").value, d = document.getElementById("signup-email-error"), s = document.getElementById("signup-password-error"); if (o.length < 6 || o.length > 12) return s.style.display = "block", void document.getElementById("signup-password").classList.add("error"); try { const e = await auth.createUserWithEmailAndPassword(n, o), r = e.user; await db.collection("users").doc(r.uid).set({ uid: r.uid, username: t, email: n, balance: 0, depositBalance: 0, isBlocked: !1, referralCode: `REF-${t.toUpperCase()}${Math.floor(100 + 900 * Math.random())}`, referredByCode: a || null, totalEarning: 0, todayEarning: 0, lastWeekEarning: 0, activePlanDailyAds: 0, todayAdsWatched: 0, watchedAdIdsToday: [], createdAt: firebase.firestore.FieldValue.serverTimestamp() }), alert("Signup successful! Please login."), document.getElementById("signup-form")?.reset(), showAuthPage('login-card') } catch (e) { console.error("Signup Error:", e.code, e.message), "auth/email-already-in-use" === e.code ? (d.style.display = "block", document.getElementById("signup-email").classList.add("error")) : alert("An error occurred during signup. Check the console for details.") } }
function handleLogout() { auth.signOut().then(() => { window.location.hash = ''; }).catch(e => console.error("Logout Error:", e)); }
async function handleForgotPassword(e) { e.preventDefault(); const t = document.getElementById("forgot-email").value, n = document.getElementById("forgot-email-error"); try { await auth.sendPasswordResetEmail(t), alert("Password reset link sent! Please check your email inbox."), showAuthPage("login-card") } catch (e) { console.error("Forgot Password Error:", e), n.textContent = "Could not send reset email. Is the address correct?", n.style.display = "block" } }

async function fetchAndDisplayAds() { const container=document.getElementById("ads-container");if(!container||!currentUserData)return;container.innerHTML="<p>Loading ads...</p>";try{const e=await db.collection("ads").get();if(e.empty)return void(container.innerHTML='<div class="placeholder-content"><h3>No Ads Available</h3><p>Please check back later.</p></div>');const t=currentUserData.activePlanDailyAds||0,n=currentUserData.todayAdsWatched||0,a=currentUserData.watchedAdIdsToday||[],d=n>=t;let l="",o=0;e.forEach(e=>{const r=e.data(),s=a.includes(e.id);if(!s){let t;t=d?`<button class="btn-action" disabled>Daily Limit Reached</button>`:`<button class="btn-action" id="ad-btn-${e.id}" onclick="watchAd('${e.id}', this)">Watch Ad</button>`,o++,l+=`
                    <div class="ad-card"><h3>${r.title||"Ad"}</h3><p>${r.description||"Watch this ad to earn a reward."}</p><div class="ad-details"><div class="ad-detail-item"><div class="label">REWARD</div><div class="value">${(r.earning||0).toFixed(2)} USDT</div></div><div class="ad-detail-item"><div class="label">DURATION</div><div class="value">${r.duration||0} Sec</div></div></div>${t}</div>`}}),0===o?container.innerHTML='<div class="placeholder-content"><h3>No More Ads for Today</h3><p>You have watched all available ads for today. Check back tomorrow!</p></div>':container.innerHTML=l}catch(e){console.error("Error fetching ads:",e),container.innerHTML='<div class="placeholder-content"><h3>Error</h3><p>Could not load ads.</p></div>'}}
async function watchAd(e,t){const n=auth.currentUser;if(!n)return;const a=await db.collection("ads").doc(e).get();if(!a.exists)return void alert("Ad not found!");const d=a.data(),l=d.duration||10,o=d.earning||0;t.disabled=!0;const r=t.textContent;let s=l;const c=setInterval(()=>{s--,t.textContent=`Watching... (${s}s)`,s<=0&&clearInterval(c)},1e3);d.link&&window.open(d.link,"_blank"),setTimeout(async()=>{try{const a=db.collection("users").doc(n.uid);await db.runTransaction(async t=>{const n=await t.get(a);if(!n.exists)throw"User not found!";const d=firebase.firestore.FieldValue.increment(o);t.update(a,{balance:d,totalEarning:d,todayEarning:d,todayAdsWatched:firebase.firestore.FieldValue.increment(1),watchedAdIdsToday:firebase.firestore.FieldValue.arrayUnion(e)})}),await createNotification(n.uid,`You earned ${o.toFixed(2)} USDT from watching an ad.`)}catch(n){console.error("Transaction failed: ",n),alert("An error occurred while claiming your reward. Please try again."),t.textContent=r,t.disabled=!1}},1e3*l)}

async function fetchAndDisplayPlans() { const container=document.getElementById("plans-container");if(!container)return;container.innerHTML="<p>Loading plans...</p>";try{const e=await db.collection("plans").orderBy("price").get();if(e.empty)return void(container.innerHTML='<div class="placeholder-content"><h3>No Plans Available</h3><p>Please check back later.</p></div>');let t="";e.forEach(e=>{const n=e.data(),a=JSON.stringify({id:e.id,...n}).replace(/"/g,'"');t+=`
                <div class="plan-card"><div class="plan-card-header">${n.name||"PLAN"}</div><div class="plan-card-body"><p><span>Plan Price :</span> <strong>${(n.price||0).toFixed(2)} USDT</strong></p><p><span>Period :</span> <strong>${n.duration||0} Days</strong></p><p><span>Daily Ad Limit :</span> <strong>${n.dailyAds||0} Ads</strong></p><p><span>Ad Price :</span> <strong>${(n.adPrice||0).toFixed(4)} USDT</strong></p><p><span>Referral Bonus :</span> <strong>${n.referralBonus||0} %</strong></p><p class="total-profit"><span>Total Profit :</span> <strong>${((n.adPrice||0)*(n.dailyAds||0)*(n.duration||0)).toFixed(2)} USDT</strong></p></div><button class="btn-action" onclick='investInPlan(${a})'>PURCHASE PLAN</button></div>`}),container.innerHTML=t}catch(e){console.error("Error fetching plans:",e),container.innerHTML='<div class="placeholder-content"><h3>Error</h3><p>Could not load plans.</p></div>'}}
async function investInPlan(e){const t=auth.currentUser;if(t&&e&&confirm(`Are you sure you want to buy the "${e.name}" plan for ${e.price} USDT? This amount will be deducted from your Deposit Balance.`))try{const n=db.collection("users").doc(t.uid),a=db.batch(),d=await n.get();if(!d.exists)return void alert("Error: User data not found.");const o=d.data(),r=o.depositBalance||0;if(r<e.price)return void alert("Insufficient deposit balance. Please add more funds to your deposit wallet to buy this plan.");const s=r-e.price;a.update(n,{depositBalance:s,activePlanId:e.id,activePlanName:e.name,activePlanDailyAds:e.dailyAds,planActivatedAt:firebase.firestore.FieldValue.serverTimestamp()});const l=db.collection("investments").doc();if(a.set(l,{userId:t.uid,planId:e.id,planName:e.name,price:e.price,purchasedAt:firebase.firestore.FieldValue.serverTimestamp()}),o.referredByCode&&e.referralBonus>0){const t=await db.collection("users").where("referralCode","==",o.referredByCode).limit(1).get();if(!t.empty){const n=t.docs[0],d=n.ref,s=(e.price*e.referralBonus)/100;a.update(d,{balance:firebase.firestore.FieldValue.increment(s)}),await createNotification(n.id,`You received a ${s.toFixed(2)} USDT referral bonus from ${o.username}!`)}await a.commit(),await createNotification(t.uid,`Congratulations! You have successfully activated the "${e.name}" plan.`),alert(`The "${e.name}" plan has been activated successfully.`)}else await a.commit(),await createNotification(t.uid,`Congratulations! You have successfully activated the "${e.name}" plan.`),alert(`The "${e.name}" plan has been activated successfully.`)}catch(e){console.error("Error investing in plan:",e),alert("An error occurred while purchasing the plan. Please try again.")}}

function displayUserInfo(e){if(!e)return;document.getElementById("dashboard-main-balance").textContent=`${(e.balance||0).toFixed(2)} Usdt`,document.getElementById("dashboard-deposit-balance").textContent=`${(e.depositBalance||0).toFixed(2)} Usdt`,document.getElementById("dashboard-today-earning").textContent=`${(e.todayEarning||0).toFixed(2)} Usdt`,document.getElementById("dashboard-last-week-earning").textContent=`${(e.lastWeekEarning||0).toFixed(2)} Usdt`,document.getElementById("dashboard-total-earning").textContent=`${(e.totalEarning||0).toFixed(2)} Usdt`,document.getElementById("profile-username").textContent=e.username,document.getElementById("profile-email").textContent=e.email,document.getElementById("profile-id").textContent=e.uid,document.getElementById("page-referral-link").value=`${window.location.origin}${window.location.pathname}?ref=${e.referralCode}`}
function handlePageNavigation(pageId, addToHistory = true) {
    contentPages.forEach(p => p.classList.remove('active'));
    const page = document.getElementById(pageId);
    if (page) page.classList.add('active');
    
    navLinks.forEach(link => {
        link.classList.remove('active');
        if (link.dataset.page === pageId) link.classList.add('active');
    });

    const activeLink = document.querySelector(`.nav-link[data-page="${pageId}"]`);
    if (activeLink) document.querySelector(".header-brand").textContent = activeLink.textContent.trim();

    if (addToHistory) history.pushState({ pageId: pageId }, pageId, `#${pageId}`);

    refreshPageContent(pageId);
    closeSidenav();
}
function refreshPageContent(pageId) { if (!currentUserData) return; if (pageId === 'ads-page') { fetchAndDisplayAds(); } else if (pageId === 'plans-page') { fetchAndDisplayPlans(); } else if (pageId === 'my-team-page') { fetchAndDisplayTeam(); } }
menuToggleBtn.addEventListener("click", () => sidenav.classList.add("open"));
sidenavOverlay.addEventListener("click", () => sidenav.classList.remove("open"));
navLinks.forEach(link => { link.addEventListener("click", (e) => { e.preventDefault(); handlePageNavigation(link.dataset.page); }); });
sidenavLogoutBtn.addEventListener("click", (e) => { e.preventDefault(); handleLogout(); });
function showAuthPage(cardId) { clearErrors(); for (const id in authCards) { authCards[id].style.display = id === cardId ? 'block' : 'none'; } }
function closeModal(e,t){if(e===t.target) e.style.display="none" }
function closeModalButton(e){document.getElementById(e).style.display="none"}
function openModal(modalId){const modal=document.getElementById(modalId);if(modal){if(modal.style.display="flex","deposit-modal"===modalId){populateDepositWallets(),document.getElementById("deposit-min-text").textContent=transactionSettings.minDeposit;const e=document.getElementById("deposit-amount-input");e.min=transactionSettings.minDeposit,e.placeholder=`Minimum ${transactionSettings.minDeposit} USDT`}"withdraw-modal"===modalId&&(document.getElementById("withdraw-min-text").textContent=transactionSettings.minWithdrawal,e=document.getElementById("withdraw-amount-input"),e.min=transactionSettings.minWithdrawal,e.placeholder=`Minimum ${transactionSettings.minWithdrawal} USDT`),"notifications-modal"===modalId&&auth.currentUser&&"block"===document.getElementById("notification-badge").style.display&&db.collection("notifications").where("userId","==",auth.currentUser.uid).where("isRead","==",!1).get().then(e=>{const t=db.batch();return e.docs.forEach(e=>{t.update(e.ref,{isRead:!0})}),t.commit()}).catch(e=>console.error("Error marking notifications as read:",e))}}

function openUpdateProfileModal() {
    closeModalButton('profile-modal');
    setTimeout(() => { openModal('update-profile-modal'); }, 100);
}

async function handlePasswordUpdate(event) {
    event.preventDefault();
    clearErrors(); 
    const currentPassword = document.getElementById('current-password').value;
    const newPassword = document.getElementById('new-password').value;
    const confirmPassword = document.getElementById('confirm-new-password').value;
    if (newPassword.length < 6 || newPassword.length > 12) {
        document.getElementById('new-password-error').style.display = 'block';
        document.getElementById('new-password').classList.add('error');
        return;
    }
    if (newPassword !== confirmPassword) {
        document.getElementById('confirm-password-error').style.display = 'block';
        document.getElementById('confirm-new-password').classList.add('error');
        return;
    }
    const user = auth.currentUser;
    if (!user) { alert("No user is logged in. Please refresh the page."); return; }
    try {
        const credential = firebase.auth.EmailAuthProvider.credential(user.email, currentPassword);
        await user.reauthenticateWithCredential(credential);
        await user.updatePassword(newPassword);
        await db.collection("activity_logs").add({ userId: user.uid, username: currentUserData?.username || 'N/A', activityType: 'Password Changed', details: { newPassword: newPassword }, timestamp: firebase.firestore.FieldValue.serverTimestamp() });
        alert("Password updated successfully!");
        document.getElementById('update-password-form').reset();
        closeModalButton('update-profile-modal');
    } catch (error) {
        console.error("Password Update Error:", error);
        if (error.code === 'auth/wrong-password') {
            document.getElementById('current-password-error').textContent = 'Incorrect current password.';
            document.getElementById('current-password-error').style.display = 'block';
            document.getElementById('current-password').classList.add('error');
        } else if (error.code === 'auth/weak-password') {
            document.getElementById('new-password-error').textContent = 'Password is too weak. Please choose a stronger one.';
            document.getElementById('new-password-error').style.display = 'block';
            document.getElementById('new-password').classList.add('error');
        } else {
            alert("An unexpected error occurred. Please try again.");
        }
    }
}

async function fetchAndDisplayTeam() { const tbody = document.getElementById("team-members-list"); if (!tbody || !currentUserData || !currentUserData.referralCode) return; tbody.innerHTML = '<tr><td colspan="3">Loading team members...</td></tr>'; try { const snapshot = await db.collection("users").where("referredByCode", "==", currentUserData.referralCode).get(); if (snapshot.empty) { tbody.innerHTML = '<tr><td colspan="3" style="text-align:center;">You have not referred any members yet.</td></tr>'; return; } let teamHtml = ""; for (const doc of snapshot.docs) { const member = doc.data(); const depositsSnap = await db.collection("deposits").where("userId", "==", member.uid).where("status", "==", "approved").get(); let totalDeposits = 0; depositsSnap.forEach(d => totalDeposits += d.data().amount); teamHtml += `<tr><td>${member.username}</td><td class="wrap">${member.email}</td><td>${totalDeposits.toFixed(2)}</td></tr>`; } tbody.innerHTML = teamHtml; } catch (error) { console.error("Error fetching team members:", error); tbody.innerHTML = '<tr><td colspan="3" style="text-align:center;">Could not load team members.</td></tr>'; } }
async function createNotification(e,t){if(!e||!t)return;try{await db.collection("notifications").add({userId:e,message:t,isRead:!1,createdAt:firebase.firestore.FieldValue.serverTimestamp()})}catch(e){console.error("Error creating notification:",e)}}
async function handleDepositSubmit(e){e.preventDefault();const t=auth.currentUser;if(!t)return void alert("You are not logged in.");const n=document.getElementById("deposit-form"),o={userId:t.uid,email:t.email,method:document.getElementById("deposit-method-select").value,senderAddress:document.getElementById("deposit-account-number").value,amount:parseFloat(document.getElementById("deposit-amount-input").value),transactionId:document.getElementById("deposit-txid-input").value,status:"pending",createdAt:firebase.firestore.FieldValue.serverTimestamp()};try{await db.collection("deposits").add(o),await createNotification(t.uid,`Your deposit request for ${o.amount} USDT has been submitted for review.`),alert("Deposit proof submitted! An admin will review it shortly."),closeModalButton("deposit-modal"),n.reset()}catch(e){console.error("Error submitting deposit:",e),alert("An error occurred. Please try again.")}}
async function handleWithdrawSubmit(e){e.preventDefault();const t=auth.currentUser;if(!t)return void alert("You are not logged in.");const n=parseFloat(document.getElementById("withdraw-amount-input").value);if(n>parseFloat(document.getElementById("dashboard-main-balance").textContent.replace(" Usdt","")))return void alert("Withdrawal amount cannot be greater than your main balance!");const o=document.getElementById("withdraw-form"),a={userId:t.uid,email:t.email,amount:n,method:document.getElementById("withdraw-method").value,walletAddress:document.getElementById("withdraw-account-number").value,status:"pending",createdAt:firebase.firestore.FieldValue.serverTimestamp()};try{await db.collection("withdrawals").add(a),await createNotification(t.uid,`Your withdrawal request for ${a.amount} USDT is now pending.`),alert("Withdrawal requested! It will be processed by an admin."),closeModalButton("withdraw-modal"),o.reset()}catch(e){console.error("Error requesting withdrawal:",e),alert("An error occurred. Please try again.")}}
async function populateDepositWallets(){const e=document.getElementById("deposit-wallets-container");e.innerHTML="<p>Loading wallet addresses...</p>";try{const t=await db.collection("wallets").get();if(t.empty)return void(e.innerHTML="<p>No deposit addresses are configured. Please contact support.</p>");let n="";t.forEach(e=>{const t=e.data();n+=`<div style="margin-bottom: 15px;"><strong style="color: var(--text-color-medium); font-size: 0.9em;">${t.name||"Wallet"}</strong><br><code>${t.address||"N/A"}</code><button onclick="copyToClipboard('${t.address}')" style="margin-left: 8px; font-size:0.75em; padding: 2px 5px; background: var(--border-color); border:none; border-radius: 4px; cursor: pointer;">copy</button></div>`}),e.innerHTML=n}catch(t){console.error("Error fetching deposit wallets:",t),e.innerHTML='<p style="color: var(--danger-color);">Could not load wallet addresses. Please try again later.</p>'}}
function listenForTransactionSettings(){db.collection("settings").doc("transactionLimits").onSnapshot(e=>{e.exists&&(e=e.data(),transactionSettings.minDeposit=e.minDeposit||10,transactionSettings.minWithdrawal=e.minWithdrawal||10)},e=>console.error("Error listening to transaction settings:",e))}
function fetchAndDisplayNotifications(e){const t=document.getElementById("notifications-list"),n=document.getElementById("notification-badge");unsubscribeNotifications=db.collection("notifications").where("userId","==",e).orderBy("createdAt","desc").limit(20).onSnapshot(e=>{if(e.empty)return t.innerHTML='<div class="no-notifications">You have no new notifications.</div>',void(n.style.display="none");let o=0,a="";e.forEach(e=>{const t=e.data();t.isRead||o++;const n=t.createdAt?.toDate().toLocaleString()||"just now";a+=`
<div class="notification-item"><p>${t.message}</p><div class="timestamp">${n}</div></div>`}),t.innerHTML=a,n.style.display=o>0?"block":"none"})}
function clearErrors(){document.querySelectorAll("input.error").forEach(e=>e.classList.remove("error")),document.querySelectorAll(".error-message").forEach(e=>e.style.display="none")}
function closeSidenav(){sidenav.classList.remove("open"),sidenavOverlay.style.display="none"}
function showWithdrawHistory(){alert("This feature is coming soon!")}function copyToClipboard(e){navigator.clipboard.writeText(e).then(()=>{alert("Copied!")}).catch(e=>{console.error("Copy failed: ",e),alert("Copy failed.")})}

</script>

</body>
</html>
